# Requirements Document

## Introduction

Система для автоматического сбора и анализа сообщений из чатов ВКонтакте. Приложение должно получать новые сообщения через VK API, сохранять их в структурированном виде по отдельным файлам для каждого чата и предоставлять возможность анализа активности пользователей и чатов.

## Requirements

### Requirement 1

**User Story:** Как разработчик, я хочу автоматически получать новые сообщения из всех доступных чатов ВКонтакте, чтобы не пропускать активность в чатах и иметь актуальные данные для анализа.

#### Acceptance Criteria

1. WHEN система запускается THEN она SHALL подключиться к VK Messages API используя Long Poll метод
2. WHEN новое сообщение появляется в любом чате THEN система SHALL получить это сообщение в реальном времени
3. WHEN соединение с API прерывается THEN система SHALL автоматически переподключиться в течение 30 секунд
4. WHEN система получает сообщение THEN она SHALL извлечь информацию об авторе, дате, содержимом и вложениях

### Requirement 2

**User Story:** Как аналитик данных, я хочу чтобы каждый чат сохранялся в отдельный файл с определенной структурой, чтобы легко обрабатывать данные программно и визуально анализировать активность.

#### Acceptance Criteria

1. WHEN новое сообщение получено THEN система SHALL сохранить его в файл соответствующего чата
2. WHEN чат не имеет файла THEN система SHALL создать новый файл с названием чата
3. WHEN файл чата создается THEN он SHALL содержать структуру с полями name, users, activeUsers, messages
4. IF файл чата уже существует THEN система SHALL обновить только список сообщений и активных пользователей
5. WHEN сообщение сохраняется THEN оно SHALL содержать автора, дату, содержимое и вложения

### Requirement 3

**User Story:** Как аналитик, я хочу отслеживать активных пользователей в каждом чате, чтобы понимать кто наиболее вовлечен в общение и как меняется активность со временем.

#### Acceptance Criteria

1. WHEN пользователь отправляет сообщение THEN система SHALL добавить его в список activeUsers для этого чата
2. WHEN пользователь уже есть в activeUsers THEN система SHALL обновить время его последней активности
3. WHEN система обрабатывает сообщения THEN она SHALL поддерживать полный список всех users чата
4. IF пользователь новый для чата THEN система SHALL добавить его как в users, так и в activeUsers

### Requirement 4

**User Story:** Как администратор системы, я хочу чтобы система корректно обрабатывала ошибки и продолжала работу, чтобы не терять данные при временных сбоях API или файловой системы.

#### Acceptance Criteria

1. WHEN возникает ошибка API THEN система SHALL логировать ошибку и повторить запрос через экспоненциальную задержку
2. WHEN файл не может быть записан THEN система SHALL повторить попытку записи до 3 раз
3. IF все попытки записи неудачны THEN система SHALL сохранить сообщение в буфер для последующей записи
4. WHEN система восстанавливается после ошибки THEN она SHALL обработать все сообщения из буфера

### Requirement 5

**User Story:** Как разработчик, я хочу использовать типизированную структуру данных для чатов и пользователей, чтобы обеспечить консистентность данных и упростить разработку.

#### Acceptance Criteria

1. WHEN система создает файл чата THEN он SHALL соответствовать интерфейсу TChat
2. WHEN пользователь добавляется THEN он SHALL соответствовать интерфейсу TUser с полями id и name
3. WHEN сообщение сохраняется THEN оно SHALL содержать поля author, date, content, attachments
4. IF есть вложения THEN они SHALL быть сохранены в массиве attachments
5. WHEN данные записываются в файл THEN они SHALL быть в формате JSON с читаемым форматированием

### Requirement 6

**User Story:** Как пользователь системы, я хочу видеть прогресс работы и статистику сбора сообщений, чтобы понимать эффективность работы системы и количество собранных данных.

#### Acceptance Criteria

1. WHEN система обрабатывает сообщения THEN она SHALL выводить в консоль количество обработанных сообщений каждые 100 сообщений
2. WHEN новый чат обнаружен THEN система SHALL логировать создание нового файла чата
3. WHEN происходит ошибка THEN система SHALL логировать подробности ошибки с временной меткой
4. WHEN система запускается THEN она SHALL вывести общую статистику: количество отслеживаемых чатов и пользователей
